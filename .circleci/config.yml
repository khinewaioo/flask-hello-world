version: 2.1

orbs:
  # The python orb contains a set of prepackaged CircleCI configuration you can use repeatedly in your configuration files
  # Orb commands and jobs help you with common scripting around a language/tool
  # so you dont have to copy and paste it everywhere.
  # See the orb documentation here: https://circleci.com/developer/orbs/orb/circleci/python
  python: circleci/python@1.2

workflows:
  sample: 
    jobs:
      - deploy-infrastructure
      - run-application:
          requires: [deploy-infrastructure]
jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.8
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
      - run:
          name: Run tests
          command: pytest
          
  deploy-infrastructure:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: Ensure back-end infrastructure exists
          command: |
            aws cloudformation deploy \
              --template-file .circleci/server.yml \
              --tags project="udapeople" \
              --stack-name "backend" 
            Instance_IP=$(aws ec2 describe-instances \
              --query 'Reservations[*].Instances[*].PublicIpAddress' \
              --filters "Name=tag:Name,Values=dx3-learning" \
              --output text)
            curl -H "Content-Type: text/plain" -H "token: cd13d7a2-7b40-4d62-9865-c53fbca98029" --request PUT \
            --data "$Instance_IP" https://api.memstash.io/values/Instance_IP
  
  run-application:
    docker:
      - image: python:3.9.9-alpine3.15
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apk add --update ansible curl
      - run:
          name: Add  to ansible inventory
          command: |
            cd .circleci/ansible/
            instanceIP = $(curl -H "token: cd13d7a2-7b40-4d62-9865-c53fbca98029" --request GET https://api.memstash.io/values/Instance_IP)
            sed -i 's/hostname/$instanceIP/g' .hosts
      - run:
          name: Configure server
          command: |
            cd .circleci/ansible/
            ansible-playbook playbook.yml -i .hosts

            

